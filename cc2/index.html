<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>codechef-选做-again | shallwe|code</title>
  <meta name="author" content="shallwe">
  
  <meta name="description" content="OI-blog">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="codechef-选做-again"/>
  <meta property="og:site_name" content="shallwe|code"/>

  
    <meta property="og:image" content="undefined"/>
  

  
    <link rel="alternative" href="/atom.xml" title="shallwe|code" type="application/atom+xml">
  
  
    <link href="/favicon.ico" rel="icon">
  

  <!-- CSS -->
  <link rel="stylesheet" href="/css/themes/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML'></script>
  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-97384825-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?26e751f78e8841e981f7e01910d5fbf6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">shallwe|code</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>归档页
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>分类页
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>标签页
			</a>
		  </li>
		  
		  <li>
			<a href="/friend" title="All the friends.">
			  <i class="fa fa-link"></i>小伙伴
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>博主是个蒟蒻
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header page-header-inverse ">		
			<h1 class="title title-inverse "> codechef-选做-again</h1>
		</div>		
	






<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <blockquote>
<p>继续做CC中难度比较低的题目</p>
</blockquote>
<a id="more"></a>
<h1 id="cc-tripschildren-trips">【CC TRIPS】Children Trips</h1>
<h2 id="题目大意">题目大意</h2>
<p>一棵树上每个边的权值为1， 每次给出一个小盆友的体力值， 每天可以行进的距离<span class="math inline">\(\leqslant\)</span>体力值，问走<span class="math inline">\((x,y)\)</span>这条路径需要几天。</p>
<h2 id="解题报告">解题报告</h2>
<p>首先考虑体力值为1 、2 、3…的分别走步数<span class="math inline">\(n\)</span> , 总共需要走的距离是<span class="math inline">\(n^3\)</span>级别的，实际总步数是<span class="math inline">\(n^2\)</span>级别， 所以每个体力值走过的步数是<span class="math inline">\(\sqrt{n}\)</span>级别， 每一步走到哪一个节点通过倍增（二分？）<span class="math inline">\(\log n\)</span>可以得到, 复杂度<span class="math inline">\(O(n\sqrt{n}\log n)\)</span></p>
<p>如果一个体力值走的步数<span class="math inline">\(&gt; n\)</span>，那么可以对这个体力值进行重建图， 每个点连向上能到达的最远的点， 在呈现做倍增， 这个重构图的过程最多进行<span class="math inline">\(\sqrt{n}\)</span>次， 单次复杂度<span class="math inline">\(O(n\log n)\)</span>.</p>
<p>重构图之后， 通过倍增就可以<span class="math inline">\(\log n\)</span>解决一次询问， 复杂度<span class="math inline">\(O(n\log n)\)</span>.</p>
<p>所以总体的复杂度就是<span class="math inline">\(O(n \sqrt{n} \log n)\)</span></p>
<h2 id="代码">代码</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"> </div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FORU(i,  a,  b) for (int i = int(a),  nn = int(b); i &lt;= nn; ++i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FORD(i,  a,  b) for (int i = int(a),  nn = int(b); i &gt;= nn; --i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REP(i,  b) for (int i = 0,  nn = int(b); i &lt; b; ++i) </span></div><div class="line"> </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll; </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> ff; </div><div class="line"> </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">100010</span>; </div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span></div><div class="line">	<span class="keyword">int</span> u, v, c, id;</div><div class="line">	node(<span class="keyword">int</span> u=<span class="number">0</span>, <span class="keyword">int</span> v=<span class="number">0</span>, <span class="keyword">int</span> c=<span class="number">0</span>, <span class="keyword">int</span> id=<span class="number">0</span>) </div><div class="line">		:u(u), v(v), c(c), id(id) &#123;&#125;</div><div class="line">&#125; t[N];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">edge</span> &#123;</span> </div><div class="line">	<span class="keyword">int</span> nxt, to, v; </div><div class="line">	edge(<span class="keyword">int</span> nxt=<span class="number">0</span>,<span class="keyword">int</span> to=<span class="number">0</span>,<span class="keyword">int</span> v=<span class="number">0</span>) </div><div class="line">		:nxt(nxt), to(to), v(v) &#123;&#125;</div><div class="line">&#125; e[N*<span class="number">2</span>]; </div><div class="line"> </div><div class="line"><span class="keyword">int</span> n, m, d, lca, sum, c;</div><div class="line"><span class="keyword">int</span> head[N], tot; </div><div class="line"><span class="keyword">int</span> dep[N], deep[N], fa[N][<span class="number">20</span>], _fa[N][<span class="number">20</span>];</div><div class="line"><span class="keyword">int</span> st[N], top, top2;</div><div class="line"><span class="keyword">int</span> ans[N], s[N*<span class="number">2</span>];</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">cmp</span><span class="params">(node a, node b)</span></span>&#123;<span class="keyword">return</span> a.c&gt;b.c;&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> v)</span> </span>&#123;</div><div class="line"> 	e[++tot] = edge(head[x], y, v), head[x]=tot;</div><div class="line">&#125; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (deep[x] &gt; d) d = deep[x];</div><div class="line">	<span class="keyword">int</span> y; </div><div class="line">	</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; fa[x][i]; ++i) </div><div class="line">		fa[x][i+<span class="number">1</span>] = fa[ fa[x][i] ][i]; </div><div class="line"> </div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = head[x]; i; i = e[i].nxt)</div><div class="line">		<span class="keyword">if</span> (y = e[i].to, y != fa[x][<span class="number">0</span>]) &#123;</div><div class="line">			deep[y] = deep[x] + e[i].v;</div><div class="line">			dep[y] = dep[x] + <span class="number">1</span>, fa[y][<span class="number">0</span>]=x; </div><div class="line">			dfs(y);</div><div class="line">		&#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">void</span> _dfs(<span class="keyword">int</span> x) &#123;</div><div class="line">	<span class="keyword">int</span> _top = top2, y;</div><div class="line">	<span class="keyword">for</span> ( st[ ++top ] = x; deep[x]-deep[st[top2]] &gt; c; ++top2);</div><div class="line">	_fa[x][<span class="number">0</span>] = st[top2];</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; _fa[x][i]; ++i)</div><div class="line">		_fa[x][i+<span class="number">1</span>] = _fa[_fa[x][i]][i];</div><div class="line">		</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=head[x]; i; i = e[i].nxt)</div><div class="line">		<span class="keyword">if</span> (y = e[i].to, y != fa[x][<span class="number">0</span>]) </div><div class="line">			_dfs(y);</div><div class="line">			</div><div class="line">	--top, top2 = _top;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">LCA</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> v)</span> </span>&#123;</div><div class="line">	<span class="keyword">int</span> i, j;</div><div class="line">	<span class="keyword">if</span>(dep[u] &lt; dep[v]) swap(u, v);</div><div class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>, j=dep[u]-dep[v]; j; ++i, j&gt;&gt;=<span class="number">1</span>)	</div><div class="line">		<span class="keyword">if</span>(j &amp; <span class="number">1</span>) u = fa[u][i];</div><div class="line">	<span class="keyword">if</span> (u == v) <span class="keyword">return</span> u;</div><div class="line">	<span class="keyword">for</span> (i=<span class="number">17</span>; i&gt;=<span class="number">0</span>; --i) <span class="keyword">if</span>(fa[u][i] != fa[v][i])</div><div class="line">		 u = fa[u][i], v = fa[v][i];</div><div class="line">	<span class="keyword">return</span> fa[u][<span class="number">0</span>];</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;n); <span class="keyword">int</span> u, v, i, j, k; </div><div class="line">	<span class="keyword">for</span> (i=<span class="number">1</span>; i&lt;n; ++i) &#123;</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d%d"</span>, &amp;u, &amp;v, &amp;c);</div><div class="line">		add(u, v, c), add(v, u, c); </div><div class="line">	&#125;</div><div class="line">	dep[<span class="number">1</span>] = deep[<span class="number">1</span>]=<span class="number">1</span>, dfs(<span class="number">1</span>);</div><div class="line">	 </div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;m);</div><div class="line">	<span class="keyword">for</span> (i=<span class="number">1</span>; i&lt;=m; ++i)&#123;</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d%d"</span>, &amp;u, &amp;v, &amp;c); </div><div class="line">		t[i] = node(u, v, c, i); </div><div class="line">		</div><div class="line">		s[ t[i].c ] += n / t[i].c;</div><div class="line">		<span class="keyword">if</span>(s[ t[i].c ]&gt;n) s[t[i].c] = n;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	sort(t+<span class="number">1</span>, t+m+<span class="number">1</span>, cmp);</div><div class="line">	<span class="keyword">for</span> (i=<span class="number">1</span>, c=<span class="number">-1</span>; i &lt;= m; ++i) &#123;</div><div class="line">		u = t[i].u, v = t[i].v;</div><div class="line">		lca = LCA(u, v), sum=<span class="number">0</span>;</div><div class="line">		<span class="keyword">if</span>(s[ t[i].c ] &lt; n) &#123;</div><div class="line">			c = t[i].c;</div><div class="line">			<span class="keyword">for</span> (; deep[u]-deep[lca]&gt;=c; u=k, ++sum) &#123;</div><div class="line">				<span class="keyword">for</span> (j=<span class="number">17</span>, k=u; j&gt;=<span class="number">0</span>; --j)</div><div class="line">					<span class="keyword">if</span>(deep[u] - deep[fa[k][j]] &lt;= c)</div><div class="line">						k = fa[k][j];</div><div class="line">				<span class="keyword">if</span>(k == lca)<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="keyword">for</span> (; deep[v]-deep[lca]&gt;=c; v=k, ++sum) &#123;</div><div class="line">				<span class="keyword">for</span> (j=<span class="number">17</span>, k=v; j&gt;=<span class="number">0</span>; --j)</div><div class="line">					<span class="keyword">if</span>(deep[v]-deep[fa[k][j]] &lt;= c)</div><div class="line">						k = fa[k][j];</div><div class="line">				<span class="keyword">if</span>(k == lca)<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">			<span class="keyword">if</span>(u!=lca || v!=lca)</div><div class="line">				sum += <span class="number">1</span> + (deep[u]+deep[v]<span class="number">-2</span>*deep[lca]&gt;c);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (t[i].c != c) c = t[i].c, _dfs(<span class="number">1</span>);</div><div class="line">			<span class="keyword">for</span> (j=<span class="number">17</span>; j&gt;=<span class="number">0</span>; --j)</div><div class="line">				<span class="keyword">if</span> (deep[_fa[u][j]] - deep[lca]&gt;<span class="number">0</span>)</div><div class="line">					u=_fa[u][j], sum += <span class="number">1</span>&lt;&lt;j;</div><div class="line">			<span class="keyword">for</span> (j=<span class="number">17</span>; j&gt;=<span class="number">0</span>; --j)</div><div class="line">				<span class="keyword">if</span> (deep[_fa[v][j]] - deep[lca]&gt;<span class="number">0</span>)</div><div class="line">					v=_fa[v][j], sum += <span class="number">1</span>&lt;&lt;j;</div><div class="line">			<span class="keyword">if</span>(u!=lca || v!=lca)</div><div class="line">				sum += <span class="number">1</span>+(deep[u]+deep[v]<span class="number">-2</span>*deep[lca]&gt;c);</div><div class="line">		&#125;</div><div class="line">		ans[t[i].id] = sum;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> (i=<span class="number">1</span>; i&lt;=m; ++i) </div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ans[i]);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="cc-seaeqsereja-and-equality">【CC SEAEQ】Sereja and Equality</h1>
<h2 id="题目大意-1">题目大意</h2>
<p>子串相等在题目中的定义就是离散后对应位置相同的意思， 求所有长度为<span class="math inline">\(n\)</span>的排列中， 相等的逆序对个数不超过<span class="math inline">\(E\)</span>的子串对数。</p>
<h2 id="解题报告-1">解题报告</h2>
<p>首先求出长度为<span class="math inline">\(i\)</span>的逆序对个数不超过<span class="math inline">\(j\)</span>的排列个数， 设<span class="math inline">\(f[i][j]\)</span>表示长度为<span class="math inline">\(i\)</span>逆序对个数为<span class="math inline">\(j\)</span>的方案数， <span class="math display">\[f[i][j]=\sum_{k=0}^{i-1} f[i-1][j-k]\]</span> <span class="math display">\[g[i][j]=\sum_{k=0}^{j}f[i][k]\]</span> 直接转移就可以得到， 复杂度<span class="math inline">\(O(n^2)\)</span></p>
<p>对于一个询问<span class="math inline">\(n,E\)</span> , 枚举相等子串的长度<span class="math inline">\(l\)</span> , 对答案的贡献是<span class="math display">\[((n-l)!C_n^l(n-l+1))^2 \times g[l][E]\]</span></p>
<p>复杂度<span class="math inline">\(O(n^2+nq)\)</span></p>
<h2 id="代码-1">代码</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"> </div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FORU(i, a, b) for (int i = int(a), nn = int(b); i &lt;= nn; ++i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FORD(i, a, b) for (int i = int(a), nn = int(b); i &gt;= nn; --i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REP(i, b) for (int i = 0, nn = int(b); i &lt; b; ++i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> int ll </span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll; </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> ff; </div><div class="line"> </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">510</span>; </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> p = <span class="number">1000000007</span>; </div><div class="line"> </div><div class="line"><span class="keyword">int</span> f[N][N*N/<span class="number">2</span>], test, C[N][N], fac[N];</div><div class="line"> </div><div class="line">main() &#123; </div><div class="line">	f[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>, f[<span class="number">1</span>][<span class="number">0</span>] = <span class="number">1</span>; </div><div class="line">	</div><div class="line">	<span class="keyword">int</span> n = <span class="number">500</span>, E, pE, dl; </div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; ++i) &#123; </div><div class="line">		E = i*(i<span class="number">-1</span>) / <span class="number">2</span>, pE = (i<span class="number">-1</span>)*(i<span class="number">-2</span>)/<span class="number">2</span>; </div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt;= E; ++j) &#123;</div><div class="line">			f[i][j] = f[i<span class="number">-1</span>][min(j, pE)]; </div><div class="line">			dl = j - i; </div><div class="line">			<span class="keyword">if</span> (dl &gt;= <span class="number">0</span>) f[i][j] -= f[i<span class="number">-1</span>][dl]; </div><div class="line">			<span class="keyword">if</span> (f[i][j] &gt;= p) f[i][j] -= p; </div><div class="line">			<span class="keyword">if</span> (f[i][j] &lt; <span class="number">0</span>) f[i][j] += p; </div><div class="line">		&#125; </div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= E; ++j) &#123;</div><div class="line">			f[i][j] += f[i][j<span class="number">-1</span>]; </div><div class="line">			<span class="keyword">if</span> (f[i][j] &gt;= p) f[i][j] -= p ;</div><div class="line">		&#125; </div><div class="line">	&#125;</div><div class="line"> </div><div class="line">	</div><div class="line">	C[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>; </div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;=n; ++i) &#123;</div><div class="line">		C[i][<span class="number">0</span>] = <span class="number">1</span>; </div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">1</span>; j&lt;=i; ++j) &#123;</div><div class="line">			C[i][j] = C[i<span class="number">-1</span>][j] + C[i<span class="number">-1</span>][j<span class="number">-1</span>]; </div><div class="line">			<span class="keyword">if</span> (C[i][j] &gt;= p) C[i][j] -= p; </div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fac[<span class="number">0</span>] = <span class="number">1</span>; </div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;=n; ++i) </div><div class="line">		fac[i] = <span class="number">1L</span>L * fac[i<span class="number">-1</span>] * i % p; </div><div class="line">	</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;test);  </div><div class="line">	 </div><div class="line">	<span class="keyword">while</span> (test --) &#123; </div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;n, &amp;E); </div><div class="line">		<span class="keyword">int</span> ans = <span class="number">0</span>; </div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">1</span>; l &lt;= n; ++l) &#123;</div><div class="line">			ll x = C[n][l]  * fac[n-l] % p  ; </div><div class="line">			ans += x * x % p * (n-l+<span class="number">1</span>) % p * f[l][min(l*(l<span class="number">-1</span>)/<span class="number">2</span>, E)] % p;</div><div class="line">			<span class="keyword">if</span> (ans &gt;= p) ans -= p; </div><div class="line">		&#125; </div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, ans); </div><div class="line">	&#125; </div><div class="line">	</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="cc-parsinsine-partition-function">【CC PARSIN】Sine Partition Function</h1>
<h2 id="题目大意-2">题目大意</h2>
<p><span class="math display">\[f(n, m, x) = \sum_k sin(k_1x)sin(k_2x)···sin(k_mx)\]</span></p>
<p>其中<span class="math inline">\(k_1+k_2+...+k_m=n\)</span> .</p>
<p>求<span class="math inline">\(f(n, m, x)\)</span></p>
<h2 id="解题报告-2">解题报告</h2>
<p>考虑<span class="math inline">\(n+1\)</span> , 有两个情况， 一种在末尾添加一个<span class="math inline">\(sin(x)\)</span>， 一种是将<span class="math inline">\(k_m+1\)</span>。</p>
<p>后一种情况出现和和差角问题， 利用高中（我并没有学过）的三角函数知识， 需要利用<span class="math inline">\(cos(k_mx)\)</span>进行转移。</p>
<p>令<span class="math inline">\(g(n,m,x)=\sum_k sin(k_1x)sin(k_2x)···cos(k_mx)\)</span></p>
<p>可以得到： <span class="math display">\[f(n,m,x)=f(n-1,m,x)cosx+(f(n-1,m-1,x)+g(n-1,m-1,x))sinx\]</span> <span class="math display">\[g(n,m,x)=(f(n-1,m-1,x)-f(n-1,m,x))sinx+g(n-1,m,x)cosx\]</span></p>
<p>因为<span class="math inline">\(m\)</span>很小， 所以把两个数组都压到矩阵里， 大力快速幂+矩阵乘法就搞了。</p>
<h2 id="代码-2">代码</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"> </div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FORU(i, a, b) for (int i = int(a), nn = int(b); i &lt;= nn; ++i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FORD(i, a, b) for (int i = int(a), nn = int(b); i &gt;= nn; --i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REP(i, b) for (int i = 0, nn = int(b); i &lt; b; ++i) </span></div><div class="line"> </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll; </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">double</span> ff; </div><div class="line"> </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> M = <span class="number">31</span>; </div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">matrix</span> &#123;</span> </div><div class="line">	<span class="keyword">int</span> x, y; </div><div class="line">	ff a[M+M][M+M]; </div><div class="line">	matrix() &#123;</div><div class="line">		<span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a)); </div><div class="line">		x = y = <span class="number">0</span>; </div><div class="line">	&#125; </div><div class="line">	matrix(<span class="keyword">int</span> x, <span class="keyword">int</span> y,<span class="keyword">int</span> t=<span class="number">0</span>) </div><div class="line">	:x(x), y(y) &#123; </div><div class="line">		<span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a)); </div><div class="line">		<span class="keyword">if</span> (t == <span class="number">1</span>) </div><div class="line">			REP(i, x) a[i][i] = <span class="number">1</span>; </div><div class="line">	&#125; </div><div class="line">	matrix <span class="keyword">operator</span> *(<span class="keyword">const</span> matrix b)<span class="keyword">const</span>&#123; </div><div class="line">		<span class="function">matrix <span class="title">c</span><span class="params">(x, b.y)</span> </span>; </div><div class="line">		REP(i, c.x) REP(j, c.y) REP(k, y) </div><div class="line">			c.a[i][j] += a[i][k]*b.a[k][j]; </div><div class="line">		<span class="keyword">return</span> c; </div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">		</div><div class="line">	 	<span class="built_in">cout</span> &lt;&lt; x &lt;&lt; <span class="string">' '</span> &lt;&lt; y &lt;&lt; <span class="built_in">endl</span>; </div><div class="line">	 	REP(i, x) REP(j, y) <span class="built_in">cout</span> &lt;&lt; a[i][j] &lt;&lt; ((j+<span class="number">1</span>==y)?<span class="string">'\n'</span>:<span class="string">' '</span>);</div><div class="line">	 	</div><div class="line">	 	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>; </div><div class="line">	 &#125; </div><div class="line">	  </div><div class="line">&#125; trans, ini; </div><div class="line"> </div><div class="line"><span class="keyword">int</span> test, n, m; ff X;</div><div class="line"> </div><div class="line"><span class="function">matrix <span class="title">fast</span><span class="params">(matrix x, <span class="keyword">int</span> k)</span> </span>&#123;</div><div class="line"> 	<span class="function">matrix <span class="title">ans</span><span class="params">(x.x, x.y, <span class="number">1</span>)</span></span>; </div><div class="line"> 	<span class="keyword">for</span> (; k; k&gt;&gt;=<span class="number">1</span>, x=x*x) </div><div class="line"> 		<span class="keyword">if</span> (k &amp; <span class="number">1</span>) ans = ans*x; </div><div class="line"> 	<span class="keyword">return</span> ans; </div><div class="line">&#125; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	ios :: sync_with_stdio(<span class="literal">false</span>); </div><div class="line">	</div><div class="line">	<span class="built_in">cin</span> &gt;&gt; test; </div><div class="line">	<span class="keyword">while</span> (test --) &#123; </div><div class="line">		<span class="built_in">cin</span> &gt;&gt; m &gt;&gt; n &gt;&gt; X; </div><div class="line">		</div><div class="line">		ini = trans = matrix(); </div><div class="line">		ini.x = (m+<span class="number">1</span>)*<span class="number">2</span>, ini.y = <span class="number">1</span>; </div><div class="line">		ini.a[<span class="number">0</span>][<span class="number">0</span>]=ini.a[m+<span class="number">1</span>][<span class="number">0</span>]=<span class="number">1</span>; </div><div class="line">		</div><div class="line">		trans.x=trans.y=(m+<span class="number">1</span>)*<span class="number">2</span>; </div><div class="line">		ff _s = <span class="built_in">sin</span>(X), _c = <span class="built_in">cos</span>(X); </div><div class="line">		REP(i, trans.x) </div><div class="line">			<span class="keyword">if</span> (i == <span class="number">0</span> || i == m+<span class="number">1</span>) </div><div class="line">				<span class="keyword">continue</span>; </div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (i &lt;= m) &#123; </div><div class="line">					trans.a[i][i<span class="number">-1</span>]=_s; </div><div class="line">					trans.a[i][i]=_c; </div><div class="line">					trans.a[i][m+<span class="number">1</span>+i]=_s; </div><div class="line">				&#125; <span class="keyword">else</span> &#123; </div><div class="line">					trans.a[i][i-(m+<span class="number">1</span>)<span class="number">-1</span>]=_c; </div><div class="line">					trans.a[i][i-(m+<span class="number">1</span>)]=-_s; </div><div class="line">					trans.a[i][i]=_c; </div><div class="line">				&#125; </div><div class="line">		</div><div class="line">		trans = fast(trans, n); </div><div class="line">		</div><div class="line"><span class="comment">//		trans.print(); </span></div><div class="line">		trans = trans * ini; </div><div class="line">		</div><div class="line">		<span class="built_in">cout</span> &lt;&lt; trans.a[m][<span class="number">0</span>] &lt;&lt; <span class="built_in">endl</span>; </div><div class="line">	&#125; </div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="cc-lecoinslittle-elephant-and-colored-coins">【CC LECOINS】Little Elephant and Colored Coins</h1>
<h2 id="题目大意-3">题目大意</h2>
<p>有<span class="math inline">\(n\)</span>种硬币， 每种硬币无限使用， 有一个价值<span class="math inline">\(v\)</span>和颜色<span class="math inline">\(c\)</span>， 每次询问能否凑出价值<span class="math inline">\(S\)</span>， 最多用多少颜色。</p>
<h2 id="解题报告-3">解题报告</h2>
<p>对价值最小的硬币做模意义， 因为价值最大是<span class="math inline">\(200000\)</span>。</p>
<p>设<span class="math inline">\(f[i][j]\)</span>表示使用<span class="math inline">\(i\)</span>种颜色，价值模意义下为<span class="math inline">\(j\)</span>的最小能凑出的价值， 把同一种颜色的硬币放在一起， 对<span class="math inline">\(f[i][j]\)</span>从<span class="math inline">\(f[i-1][k]\)</span>进行更新， 然后利用取模成环的性质，对<span class="math inline">\(f[i][j]\)</span>从<span class="math inline">\(f[i][k]\)</span>更新， 复杂度是<span class="math inline">\(O(n^2*V)\)</span></p>
<p>（要把和价值最小硬币颜色相同的硬币单独拿出来， 更新<span class="math inline">\(f[i][j]\)</span>得到<span class="math inline">\(g[i][j]\)</span>）</p>
<p>询问的时候， 枚举<span class="math inline">\(i\)</span>, 看<span class="math inline">\(f[i][S%V]\)</span>和<span class="math inline">\(S\)</span>的大小关系， 在判断<span class="math inline">\(g[i][S%V]\)</span>和<span class="math inline">\(S\)</span>的大小关系， 更新答案</p>
<p>时间复杂度<span class="math inline">\(O(n^2V+Q*n)\)</span></p>
<h2 id="代码-3">代码</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"> </div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FORU(i, a, b) for (int i = int(a), nn = int(b); i &lt;= nn; ++i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> FORD(i, a, b) for (int i = int(a), nn = int(b); i &gt;= nn; --i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REP(i, b) for (int i = 0, nn = int(b); i &lt; b; ++i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> pb push_back</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> se second </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> fi first</span></div><div class="line"> </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll; </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> ff; </div><div class="line"><span class="keyword">typedef</span> <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vi; </div><div class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; pii; </div><div class="line"> </div><div class="line"><span class="keyword">const</span> ll INF = <span class="number">1000000000000000000L</span>L;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">200005</span>;</div><div class="line"> </div><div class="line"><span class="keyword">int</span> n, m, cnt; ll mV, mC, V[N]; </div><div class="line">pii A[<span class="number">64</span>];</div><div class="line">ll R[<span class="number">64</span>][N],  _R[<span class="number">64</span>][N];</div><div class="line"><span class="keyword">bool</span> U[N];</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="built_in">vector</span>&lt; pii &gt; T)</span> </span>&#123;</div><div class="line">	FORD (i, cnt, <span class="number">0</span>) REP (it, T.size())</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = mV<span class="number">-1</span>; j &gt;= <span class="number">0</span>; j--)</div><div class="line">			<span class="keyword">if</span> (R[i][j] &lt; INF) R[i+<span class="number">1</span>][(j+T[it].se)%mV] = </div><div class="line">					min(R[i+<span class="number">1</span>][(j+T[it].se)%mV], R[i][j]+T[it].se);</div><div class="line">					</div><div class="line">	REP(i, cnt+<span class="number">2</span>) REP(j, T.size()) &#123;</div><div class="line">		ll v = T[j].se, vm = v%mV;</div><div class="line">		<span class="keyword">if</span> (vm == <span class="number">0</span>) <span class="keyword">continue</span>;</div><div class="line">		<span class="keyword">int</span> d = __gcd((ll)vm, mV);</div><div class="line">		REP(x, d) &#123;</div><div class="line">			<span class="keyword">int</span> z = x, y = x;</div><div class="line">			<span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">				<span class="keyword">if</span> (R[i][y] &lt; R[i][z]) z = y;</div><div class="line">				y = (y + vm) % mV;</div><div class="line">				<span class="keyword">if</span> (y == x) <span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			y = z;</div><div class="line">			<span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">				<span class="keyword">int</span> w = (y + vm) % mV;</div><div class="line">				R[i][w] = min(R[i][w], R[i][y]+v);</div><div class="line">				y = w; <span class="keyword">if</span> (y == z) <span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	REP(i, <span class="number">64</span>) REP(j, N) R[i][j] = INF;</div><div class="line">	R[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">	<span class="built_in">cin</span> &gt;&gt; n;</div><div class="line">	mV = INF, mC = <span class="number">-1</span>;</div><div class="line">	REP(i, n) &#123;</div><div class="line">		<span class="built_in">cin</span> &gt;&gt; A[i].se &gt;&gt; A[i].fi;</div><div class="line">		<span class="keyword">if</span> (A[i].se &lt; mV) </div><div class="line">			mV = A[i].se, mC = A[i].fi;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	sort(A, A+n);</div><div class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">	<span class="built_in">vector</span>&lt; pii &gt; _T;</div><div class="line">	<span class="keyword">while</span> (i &lt; n) &#123;</div><div class="line">		<span class="keyword">if</span> (A[i].first == mC) &#123;</div><div class="line">			<span class="keyword">if</span> (A[i].se != mV) _T.pb(A[i]);</div><div class="line">			i ++; <span class="keyword">continue</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line">		<span class="built_in">vector</span>&lt; pii &gt; T;</div><div class="line">		<span class="keyword">while</span> (i+j&lt;n &amp;&amp; A[i+j].fi==A[i].fi) </div><div class="line">			T.pb(A[i+j]), j ++;</div><div class="line">			</div><div class="line">		update(T), i += j, cnt ++;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	REP(i, <span class="number">64</span>) REP(j, mV) _R[i][j] = R[i][j];</div><div class="line">	update(_T), cnt ++;</div><div class="line"> </div><div class="line">	<span class="built_in">cin</span> &gt;&gt; m;</div><div class="line">	</div><div class="line">	REP(i, m) &#123; </div><div class="line">		ll s; <span class="keyword">int</span> res = <span class="number">-1</span>;</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%lld"</span>, &amp;s);</div><div class="line">		REP(j, n+<span class="number">1</span>) &#123;</div><div class="line">			ll d = _R[j][s % mV];</div><div class="line">			<span class="keyword">if</span> (d &gt;= INF) <span class="keyword">continue</span>;</div><div class="line">			<span class="keyword">if</span> (d &gt; s) <span class="keyword">continue</span>;</div><div class="line">			<span class="keyword">if</span> (d == s) res = max(res, j);</div><div class="line">			<span class="keyword">else</span> res = max(res, j + <span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (!_T.empty()) &#123;</div><div class="line">			REP(j, n+<span class="number">1</span>)  &#123;</div><div class="line">				ll d = R[j][s % mV];</div><div class="line">				<span class="keyword">if</span> (d &gt;= INF) <span class="keyword">continue</span>;</div><div class="line">				<span class="keyword">if</span> (d &gt; s) <span class="keyword">continue</span>;</div><div class="line">				res = max(res, j);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, res);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="cc-anudtq-dynamic-trees-and-queries">【CC ANUDTQ】 Dynamic Trees and Queries</h1>
<h2 id="题目大意-4">题目大意</h2>
<p>四种操作： 1. 向一个点连一个权值为<span class="math inline">\(v\)</span>的叶子； 2. 向一个点的子树加一个权值<span class="math inline">\(v\)</span>; 3. 删除一棵子树； 4. 询问一棵子树的权值和；</p>
<h2 id="解题报告-4">解题报告</h2>
<p>本来增加连边的问题要先试试LCT, 但设计子树加和子树查询要维护若干信息， 比较麻烦。</p>
<p>如果用SPLAY维护出栈入栈序就十分的方便， 具体的， 就是每个点有一个入栈点和一个出栈点， 出栈点是没有权值的size的。</p>
<p>剩下就是模板了。。</p>
<h2 id="代码-4">代码</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REP(i,a,b) for(int i=int(a),nn=int(b);i&lt;=nn;i++)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> pb push_back</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> mp make_pair</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> fi first</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> se second</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> DEBUG(x) cout &lt;&lt; (#x) &lt;&lt; <span class="meta-string">": "</span> &lt;&lt; x &lt;&lt;endl;</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> int ll</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"> </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> f;</div><div class="line"><span class="keyword">typedef</span> pair&lt;<span class="keyword">int</span>,<span class="keyword">int</span>&gt; pii;</div><div class="line"><span class="keyword">typedef</span> <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; vi;</div><div class="line"> </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N=<span class="number">400020</span>;</div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">edge</span>&#123;</span></div><div class="line">	<span class="keyword">int</span> to, nxt; </div><div class="line">	edge(<span class="keyword">int</span> nxt=<span class="number">0</span>,<span class="keyword">int</span> to=<span class="number">0</span>):nxt(nxt),to(to)&#123;&#125;</div><div class="line">&#125; e[N];</div><div class="line"><span class="keyword">int</span> head[N], n, cnt, tot, rec, rt; </div><div class="line"><span class="keyword">int</span> sn[N][<span class="number">2</span>], fa[N], sz[N], s[N], key[N], sm[N], ps[N], dn[N], ot[N], Eu[N]; </div><div class="line">ll ans;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">in</span><span class="params">()</span> </span>&#123; </div><div class="line">	<span class="keyword">char</span> ch = getchar(); <span class="keyword">int</span> f=<span class="number">1</span>,x =<span class="number">0</span>; </div><div class="line">	<span class="keyword">for</span> (;ch&lt;<span class="string">'0'</span>||ch&gt;<span class="string">'9'</span>;ch=getchar())</div><div class="line">		<span class="keyword">if</span> (ch==<span class="string">'-'</span>) f = <span class="number">-1</span>; </div><div class="line">	<span class="keyword">for</span> (;ch&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>;ch=getchar())</div><div class="line">		x=x*<span class="number">10</span>+ch<span class="number">-48</span>; </div><div class="line">	<span class="keyword">return</span> x*f; </div><div class="line">&#125; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;</div><div class="line">	e[++tot]=edge(head[x], y), head[x]=tot;</div><div class="line">	e[++tot]=edge(head[y], x), head[y]=tot;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">birth</span><span class="params">(<span class="keyword">int</span> _v, <span class="keyword">int</span> _s)</span> </span>&#123;</div><div class="line">	++cnt, sn[cnt][<span class="number">0</span>]=sn[cnt][<span class="number">1</span>]=fa[cnt]=<span class="number">0</span>, sz[cnt]=s[cnt]=_s; </div><div class="line">	key[cnt] = sm[cnt] = _v; <span class="keyword">return</span> cnt;  </div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ad</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> _v)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (!x) <span class="keyword">return</span>;  </div><div class="line">	ps[x] += _v, sm[x] += _v * sz[x]; </div><div class="line">	key[x] += s[x] * _v; </div><div class="line">&#125; </div><div class="line">	</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">up</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; </div><div class="line">	sz[x] = s[x], sm[x] = key[x]; </div><div class="line">	<span class="keyword">if</span> (sn[x][<span class="number">0</span>]) sz[x] += sz[sn[x][<span class="number">0</span>]], sm[x] += sm[sn[x][<span class="number">0</span>]]; </div><div class="line">	<span class="keyword">if</span> (sn[x][<span class="number">1</span>]) sz[x] += sz[sn[x][<span class="number">1</span>]], sm[x] += sm[sn[x][<span class="number">1</span>]]; </div><div class="line">&#125; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">down</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; </div><div class="line">	<span class="keyword">if</span> (!x) <span class="keyword">return</span>; </div><div class="line">	<span class="keyword">if</span> (ps[x]) ad(sn[x][<span class="number">0</span>], ps[x]), ad(sn[x][<span class="number">1</span>], ps[x]), ps[x]=<span class="number">0</span>; </div><div class="line">&#125; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">rotate</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; </div><div class="line">	<span class="keyword">int</span> y = fa[x], z = fa[y], d = (sn[y][<span class="number">1</span>]==x); </div><div class="line">	fa[x] = z; <span class="keyword">if</span> (z) sn[z][sn[z][<span class="number">1</span>]==y] = x; </div><div class="line">	<span class="keyword">if</span> (sn[x][d^<span class="number">1</span>]) fa[sn[x][d^<span class="number">1</span>]] = y; sn[y][d] = sn[x][d^<span class="number">1</span>]; </div><div class="line">	fa[y] = x, sn[x][d^<span class="number">1</span>] = y, up(y); </div><div class="line">&#125; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">splay</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> aim=<span class="number">0</span>)</span></span>&#123;</div><div class="line">	<span class="keyword">static</span> <span class="keyword">int</span> stk[N], top=<span class="number">0</span>, tmp; tmp = x;  </div><div class="line">	<span class="keyword">while</span> (tmp != aim) stk[++top]=tmp, tmp=fa[tmp]; </div><div class="line">	<span class="keyword">while</span> (top) down(stk[top]), --top; </div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> y=fa[x]; y!=aim; rotate(x), y=fa[x]) &#123;</div><div class="line">		<span class="keyword">if</span> (fa[y] == aim) <span class="keyword">continue</span>; </div><div class="line">		<span class="keyword">if</span> ((sn[y][<span class="number">0</span>]==x)^(sn[fa[y]][<span class="number">0</span>]==y)) rotate(x); </div><div class="line">		<span class="keyword">else</span> rotate(y); </div><div class="line">	&#125;</div><div class="line">	up(x); <span class="keyword">if</span> (!aim) rt = x; </div><div class="line">&#125; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> fa)</span></span>&#123;</div><div class="line">	Eu[ ++rec ] = dn[x];</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=head[x], y; i; i=e[i].nxt)</div><div class="line">		<span class="keyword">if</span> (y = e[i].to, y != fa) dfs(y, x);</div><div class="line">	Eu[ ++rec ] = ot[x];</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span> (l &gt; r) <span class="keyword">return</span> <span class="number">0</span>; </div><div class="line">	<span class="keyword">int</span> mid = (l+r) &gt;&gt; <span class="number">1</span>, x = Eu[mid];</div><div class="line">	sn[x][<span class="number">0</span>] = build(l, mid<span class="number">-1</span>);</div><div class="line">	<span class="keyword">if</span> (sn[x][<span class="number">0</span>]) fa[sn[x][<span class="number">0</span>]] = x;</div><div class="line">	sn[x][<span class="number">1</span>] = build(mid+<span class="number">1</span>, r); </div><div class="line">	<span class="keyword">if</span> (sn[x][<span class="number">1</span>]) fa[sn[x][<span class="number">1</span>]] = x; </div><div class="line">	up(x); <span class="keyword">return</span> x;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">pre</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</div><div class="line">	splay(x);</div><div class="line">	<span class="keyword">if</span> (!sn[x][<span class="number">0</span>]) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span> (x = sn[x][<span class="number">0</span>], down(x); sn[x][<span class="number">1</span>];) </div><div class="line">		x = sn[x][<span class="number">1</span>], down(sn[x][<span class="number">1</span>]);</div><div class="line">	<span class="keyword">return</span> x;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">main() &#123;</div><div class="line"><span class="comment">//	freopen("A.in", "r", stdin); </span></div><div class="line">	n = in();</div><div class="line">	REP(i, <span class="number">1</span>, n) &#123;</div><div class="line">		dn[i] = birth(in(), <span class="number">1</span>);</div><div class="line">		ot[i] = birth(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line">	REP(i, <span class="number">1</span>, n<span class="number">-1</span>) add(in()+<span class="number">1</span>, in()+<span class="number">1</span>);</div><div class="line">	dfs(<span class="number">1</span>, <span class="number">0</span>), rt = build(<span class="number">1</span>, rec);</div><div class="line">	</div><div class="line">	<span class="keyword">int</span> t, x, tmp; </div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> m = in(); m--; ) &#123;</div><div class="line">		t = in(), x = in()+<span class="number">1</span>+ans;</div><div class="line">		<span class="keyword">if</span> (t == <span class="number">1</span>)&#123;</div><div class="line">			dn[++n] = birth(in(), <span class="number">1</span>), ot[n] = birth(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">			sn[dn[n]][<span class="number">1</span>] = ot[n], fa[ot[n]] = dn[n]; </div><div class="line">			splay(ot[x]), tmp = sn[ot[x]][<span class="number">0</span>];</div><div class="line">			sn[ot[x]][<span class="number">0</span>] = dn[n], fa[dn[n]] = ot[x];</div><div class="line">			sn[dn[n]][<span class="number">0</span>] = tmp;</div><div class="line">			<span class="keyword">if</span> (tmp) fa[tmp] = dn[n];</div><div class="line">			up(dn[n]), up(ot[x]); </div><div class="line"><span class="comment">//			DEBUG(sz[ot[x]]); </span></div><div class="line">		&#125;  	</div><div class="line">		<span class="keyword">if</span> (t == <span class="number">2</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (!pre(dn[x])) </div><div class="line">				splay(ot[x]), ad(sn[rt][<span class="number">0</span>], in()), up(rt); </div><div class="line">			<span class="keyword">else</span> &#123;</div><div class="line">				splay(pre(dn[x])), splay(ot[x], rt);</div><div class="line">				ad(sn[sn[rt][<span class="number">1</span>]][<span class="number">0</span>], in());</div><div class="line">				up(sn[rt][<span class="number">1</span>]), up(rt); </div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (t == <span class="number">3</span>) &#123;</div><div class="line">			splay(pre(dn[x])), splay(ot[x], rt);</div><div class="line">			sn[sn[rt][<span class="number">1</span>]][<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">			up(sn[rt][<span class="number">1</span>]), up(rt); </div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (t == <span class="number">4</span>) &#123;</div><div class="line">			<span class="keyword">if</span> (!pre(dn[x]))</div><div class="line">				splay(ot[x]), <span class="built_in">printf</span>(<span class="string">"%lld\n"</span>,ans=sm[sn[rt][<span class="number">0</span>]]);</div><div class="line">			<span class="keyword">else</span> &#123;</div><div class="line">				splay(pre(dn[x])), splay(ot[x], rt);</div><div class="line">				<span class="built_in">printf</span>(<span class="string">"%lld\n"</span>, ans=sm[sn[sn[rt][<span class="number">1</span>]][<span class="number">0</span>]]);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="cc-matchexpected-maximum-matching">【CC MATCH】Expected Maximum Matching</h1>
<h2 id="题目大意-5">题目大意</h2>
<p>一个二分图， 点<span class="math inline">\(i\)</span>和点<span class="math inline">\(j\)</span>之间有边相连的概率为<span class="math inline">\(p[i][j]\)</span>, 求期望最大匹配数。</p>
<h2 id="解题报告-5">解题报告</h2>
<p>有一个叫做Hall定理的东西， 内容大概是， 二分图存在完美匹配的充分必要条件是一类点的任意一个大小为<span class="math inline">\(x\)</span>的点集都与另一类点中<span class="math inline">\(&gt;=x\)</span>个点相连。</p>
<p>可以注意到， 左边的点数量少到出奇， 这使得合法的状态非常的少， 使用<span class="math inline">\(2^{2^n}\)</span>表示子集是否满足Hall定理，因为子集满足Hall定理具有包含关系，也就是一个集合满足， 他的子集都需要满足， 所以通过打表， 发现状态数十分的有限。</p>
<p>然后预处理转移， 对于一个状态<span class="math inline">\(x\)</span>, 预处理出与一个右侧的点联通情况为<span class="math inline">\(S\)</span>时，得到的Hall定理状态为<span class="math inline">\(nxt\)</span> ，再预处理出与左侧每个点联通情况为<span class="math inline">\(S\)</span>的概率。</p>
<p>之后直接dp, <span class="math inline">\(f[i][j]\)</span>表示右侧前<span class="math inline">\(i\)</span>个点， Hall定理状态为<span class="math inline">\(j\)</span>的概率， 直接计算期望就好了。</p>
<h2 id="代码-5">代码</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>; </div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REP(i,a,b) for(int i=int(a),nn=int(b);i&lt;=nn;++i)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VEP(i,a,b) for(int i=int(a),nn=int(b);i&gt;=nn;--i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> rep(i,b) for(int i=0,nn=int(b);i&lt;nn;++i)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> B(x) (1u&lt;&lt;(x))</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll; </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">double</span> ff; </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> ui; </div><div class="line"></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">5010</span>; </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> M = <span class="number">105</span>; </div><div class="line"></div><div class="line"><span class="keyword">int</span> trans[N][<span class="number">40</span>],ful[<span class="number">6</span>],as[N],n,m,w,tot; </div><div class="line">ff f[M][N],g[M][<span class="number">40</span>],p[M][<span class="number">6</span>]; ui q[N]; <span class="built_in">map</span>&lt;ui,<span class="keyword">int</span>&gt; hsh; </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">find</span><span class="params">(ui S)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (hsh.count(S) == <span class="number">0</span>) q[hsh[S] = tot++]=S; </div><div class="line">	<span class="keyword">return</span> hsh[S]; </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; </div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;n, &amp;m); w = <span class="number">1</span>&lt;&lt;n; </div><div class="line">	rep(i, n) rep(j, m) <span class="built_in">scanf</span>(<span class="string">"%lf"</span>, &amp;p[j][i]); </div><div class="line">	rep(i,w) &#123;<span class="keyword">int</span> cnt=<span class="number">0</span>; rep(j,n) <span class="keyword">if</span>(i&amp;B(j)) ++cnt; ful[cnt]|=B(i);&#125;</div><div class="line">	<span class="keyword">int</span> k = <span class="number">0</span>; </div><div class="line">	<span class="keyword">for</span> (find(<span class="number">1</span>); k&lt;tot; ++k) &#123; </div><div class="line">		ui x = q[k]; </div><div class="line">		<span class="keyword">static</span> ui nxt[<span class="number">6</span>];</div><div class="line">		rep(i, n) nxt[i] = <span class="number">0</span>; </div><div class="line">		rep(i, w) <span class="keyword">if</span> (x &amp; B(i)) rep(j, n) nxt[j]|=B(i|B(j)); </div><div class="line">		rep(i, w) &#123; ui S = x ; </div><div class="line">			rep(j, n) <span class="keyword">if</span> (i&amp;B(j)) S|=nxt[j]; </div><div class="line">			trans[k][i] = find(S); </div><div class="line">		&#125; </div><div class="line">		VEP(i, n, <span class="number">0</span>) <span class="keyword">if</span> (x&amp;ful[i]) &#123;as[k]=i; <span class="keyword">break</span>;&#125;</div><div class="line">	&#125;</div><div class="line">	rep(i, m) rep(x, w) &#123; g[i][x]=<span class="number">1</span>;rep(j,n) </div><div class="line">		<span class="keyword">if</span>(x&amp;B(j))g[i][x]*=p[i][j];<span class="keyword">else</span> g[i][x]*=(<span class="number">1</span>-p[i][j]);&#125; </div><div class="line">	</div><div class="line">	</div><div class="line">	f[<span class="number">0</span>][<span class="number">0</span>]=<span class="number">1</span>; rep(i, m) rep(k, tot) rep(x, w) </div><div class="line">		f[i+<span class="number">1</span>][trans[k][x]] += f[i][k] * g[i][x]; </div><div class="line"></div><div class="line">	ff ans = <span class="number">0</span>; </div><div class="line">	rep(i, tot) ans += f[m][i] * (ff)as[i]; </div><div class="line">	</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"%.10lf\n"</span>, ans); </div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="cc-cot5count-on-a-treap">【CC COT5】Count on a Treap</h1>
<h2 id="题目大意-6">题目大意</h2>
<p>维护一颗Treap, 支持: 1. 插入一个key和weight分别为k, w的点； 2. 删除一个key是k的点； 3. 返回key是ku和kv的两个点在树上的距离；</p>
<h2 id="解题报告-6">解题报告</h2>
<p>主要就是挖掘Treap的性质， 也就是Treap上的点<span class="math inline">\(x\)</span>是点<span class="math inline">\(y\)</span>的祖先， 当且仅当key在<span class="math inline">\(x\)</span>，<span class="math inline">\(y\)</span>之间的数重量都小于<span class="math inline">\(w_x\)</span>;</p>
<p>treap上两个点的LCA就是key在两点之间的重量最大数， 这个使用区间最大值的 位置就可以确定；</p>
<p>那么关键就是确定一个点在treap中的深度， 这个利用点<span class="math inline">\(x\)</span>是点<span class="math inline">\(y\)</span>的祖先的条件， 分别寻找点左右两侧的祖先数量， 求和就可以得到深度。</p>
<p>点<span class="math inline">\(x\)</span>左、右祖先的个数， 实际是维护一个向左、右单调递增的序列，这个通过记录区间max和区间向左向右单增序列长度， 可以单次<span class="math inline">\(\log n\)</span>(分入左右子树)进行合并， 从而<span class="math inline">\(O(n\log^2 n)\)</span>修改+查询；</p>
<h2 id="代码-6">代码</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"> </div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REP(i,a,b) for(int i=int(a),nn=int(b);i&lt;=nn;++i)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VEP(i,a,b) for(int i=int(a),nn=int(b);i&gt;=nn;--i)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> rep(i,b) for(int i=0,nn=int(b);i&lt;nn;++i)</span></div><div class="line"> </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> ui; </div><div class="line"> </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N=<span class="number">200010</span>;</div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ask</span>  &#123;</span></div><div class="line">	<span class="keyword">int</span> tp; ui x, y;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;tp);</div><div class="line">		<span class="keyword">if</span> (tp==<span class="number">1</span>) <span class="built_in">scanf</span>(<span class="string">"%u"</span>,&amp;x); </div><div class="line">		<span class="keyword">else</span> <span class="built_in">scanf</span>(<span class="string">"%u%u"</span>, &amp;x, &amp;y);</div><div class="line">	&#125;</div><div class="line">&#125; as[N];</div><div class="line"> </div><div class="line">ui x[N],y[N];</div><div class="line"> </div><div class="line"><span class="keyword">int</span> n, m, now, ans;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(ui *a, ui x)</span> </span>&#123; </div><div class="line">	<span class="keyword">int</span> l=<span class="number">1</span>, r=m+<span class="number">1</span>, ans=<span class="number">0</span>;</div><div class="line">	<span class="keyword">while</span> (l &lt; r) &#123;</div><div class="line">		<span class="keyword">int</span> mid = l+r&gt;&gt;<span class="number">1</span>;</div><div class="line">		<span class="keyword">if</span> (a[mid] &gt;= x)</div><div class="line">			ans = mid, r = mid;</div><div class="line">		<span class="keyword">else</span> l = mid+<span class="number">1</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> ans;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">int</span> l[N&lt;&lt;<span class="number">2</span>], r[N&lt;&lt;<span class="number">2</span>], we[N&lt;&lt;<span class="number">2</span>], mx[N&lt;&lt;<span class="number">2</span>];</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findl</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> v)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (v==<span class="number">0</span>) <span class="keyword">return</span> l[x];</div><div class="line">	<span class="keyword">if</span> (v &gt; mx[x]) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (l[x] == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span> (v &lt;= mx[x&lt;&lt;<span class="number">1</span>]) </div><div class="line">		<span class="keyword">return</span> l[x]-l[x&lt;&lt;<span class="number">1</span>]+findl(x&lt;&lt;<span class="number">1</span>, v);</div><div class="line">	<span class="keyword">return</span> findl(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, v);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findr</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> v)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (v==<span class="number">0</span>) <span class="keyword">return</span> r[x];</div><div class="line">	<span class="keyword">if</span> (v &gt; mx[x]) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (r[x] == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	<span class="keyword">if</span> (v &lt;= mx[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]) </div><div class="line">		<span class="keyword">return</span> r[x]-r[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]+findr(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,v);</div><div class="line">	<span class="keyword">return</span> findr(x&lt;&lt;<span class="number">1</span>,v);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">push_up</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (mx[x&lt;&lt;<span class="number">1</span>]&gt;mx[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]) &#123;</div><div class="line">		mx[x]=mx[x&lt;&lt;<span class="number">1</span>]; we[x]=we[x&lt;&lt;<span class="number">1</span>];</div><div class="line">	&#125; <span class="keyword">else</span>  &#123;</div><div class="line">		mx[x]=mx[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]; we[x]=we[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>];</div><div class="line">	&#125;</div><div class="line">	l[x]=l[x&lt;&lt;<span class="number">1</span>]+findl(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>, mx[x&lt;&lt;<span class="number">1</span>]);</div><div class="line">	r[x]=r[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]+findr(x&lt;&lt;<span class="number">1</span>,mx[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> ll,<span class="keyword">int</span> rr,<span class="keyword">int</span> _l,<span class="keyword">int</span> _r)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (ll == rr) &#123;</div><div class="line">		l[x]=<span class="number">1</span>, r[x]=<span class="number">1</span>, we[x]=ll, mx[x]=_r;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">int</span> mid=ll+rr&gt;&gt;<span class="number">1</span>;</div><div class="line">		<span class="keyword">if</span> (_l&lt;=mid) insert(x&lt;&lt;<span class="number">1</span>,ll,mid,_l,_r); </div><div class="line">		<span class="keyword">else</span> insert(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,rr,_l,_r);</div><div class="line">		push_up(x);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> ll,<span class="keyword">int</span> rr,<span class="keyword">int</span> p)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (ll==rr) &#123;</div><div class="line">		l[x]=<span class="number">0</span>, r[x]=<span class="number">0</span>, we[x]=<span class="number">0</span>, mx[x]=<span class="number">0</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">int</span> mid=ll+rr&gt;&gt;<span class="number">1</span>;</div><div class="line">		<span class="keyword">if</span> (mid&gt;=p) del(x&lt;&lt;<span class="number">1</span>,ll,mid,p); </div><div class="line">		<span class="keyword">else</span> del(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,rr,p);</div><div class="line">		push_up(x);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findl</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> ll,<span class="keyword">int</span> rr,<span class="keyword">int</span> p)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (ll==rr) &#123;</div><div class="line">		now=mx[x]; <span class="keyword">return</span> <span class="number">1</span>; </div><div class="line">	&#125; <span class="keyword">else</span>&#123;</div><div class="line">		<span class="keyword">int</span> mid=ll+rr&gt;&gt;<span class="number">1</span>;</div><div class="line">		<span class="keyword">if</span> (mid&gt;=p) &#123;</div><div class="line">			<span class="keyword">int</span> ans=findl(x&lt;&lt;<span class="number">1</span>,ll,mid,p);</div><div class="line">			ans+=findl(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,now);</div><div class="line">			now=max(now,mx[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]); <span class="keyword">return</span> ans;</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">return</span> findl(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,rr,p);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findr</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> ll,<span class="keyword">int</span> rr,<span class="keyword">int</span> p)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (ll==rr) &#123;</div><div class="line">		now=mx[x]; <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">int</span> mid=ll+rr&gt;&gt;<span class="number">1</span>;</div><div class="line">		<span class="keyword">if</span> (mid&gt;=p) <span class="keyword">return</span> findr(x&lt;&lt;<span class="number">1</span>,ll,mid,p);</div><div class="line">		<span class="keyword">else</span>  &#123;</div><div class="line">			<span class="keyword">int</span> ans=findr(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,rr,p);</div><div class="line">			ans+=findr(x&lt;&lt;<span class="number">1</span>,now);</div><div class="line">			now=max(now,mx[x&lt;&lt;<span class="number">1</span>]); <span class="keyword">return</span> ans;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">findd</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> findl(<span class="number">1</span>,<span class="number">1</span>,m,x)+findr(<span class="number">1</span>,<span class="number">1</span>,m,x);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">findmax</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> ll,<span class="keyword">int</span> rr,<span class="keyword">int</span> _l,<span class="keyword">int</span> _r)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (ll&gt;_r||rr&lt;_l) <span class="keyword">return</span>;</div><div class="line">	<span class="keyword">if</span> (ll&gt;=_l&amp;&amp;rr&lt;=_r) &#123;</div><div class="line">		<span class="keyword">if</span> (mx[x]&gt;now) </div><div class="line">			now=mx[x], ans=we[x];</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> mid=ll+rr&gt;&gt;<span class="number">1</span>;</div><div class="line">	findmax(x&lt;&lt;<span class="number">1</span>,ll,mid,_l,_r);</div><div class="line">	findmax(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,rr,_l,_r);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;n);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++) as[i].read();</div><div class="line">	m=<span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++) <span class="keyword">if</span> (as[i].tp==<span class="number">0</span>) &#123;</div><div class="line">		x[++m]=as[i].x; y[m]=as[i].y;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	sort(x+<span class="number">1</span>,x+m+<span class="number">1</span>);</div><div class="line">	sort(y+<span class="number">1</span>,y+m+<span class="number">1</span>);</div><div class="line">	</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++) &#123;</div><div class="line">		<span class="keyword">if</span> (as[i].tp==<span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">int</span> l=find(x,as[i].x),r=find(y,as[i].y);</div><div class="line">			insert(<span class="number">1</span>,<span class="number">1</span>,m,l,r);</div><div class="line">		&#125; </div><div class="line">		<span class="keyword">if</span> (as[i].tp==<span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">int</span> l=find(x,as[i].x); del(<span class="number">1</span>,<span class="number">1</span>,m,l);</div><div class="line">		&#125; </div><div class="line">		<span class="keyword">if</span> (as[i].tp==<span class="number">2</span>) &#123;</div><div class="line">			<span class="keyword">int</span> l=find(x,as[i].x),r=find(x,as[i].y); now=<span class="number">0</span>; ans=<span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (l&gt;r) swap(l,r);</div><div class="line">			findmax(<span class="number">1</span>,<span class="number">1</span>,m,l,r);</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,findd(l)+findd(r)-findd(ans)*<span class="number">2</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="cc-fnfibonacci-number">【CC FN】Fibonacci Number</h1>
<h2 id="题目大意-7">题目大意</h2>
<p>在<span class="math inline">\(\mod \ p\)</span>意义下, 斐波那契数列第<span class="math inline">\(n\)</span>项<span class="math inline">\(f_n=C\)</span>的最小的<span class="math inline">\(n\)</span>.</p>
<h2 id="解题报告-7">解题报告</h2>
<p>题目中说<span class="math inline">\(p \mod 10=1/9\)</span>, 这个性质就保证了<span class="math inline">\(\sqrt{5}\)</span>在<span class="math inline">\(\mod p\)</span>意义下存在对应整数（<span class="math inline">\(5^{(p-1)/2}=1(\mod p)\)</span>）；</p>
<p>现在令<span class="math inline">\(x=\frac{\sqrt{5}+1}{2}\)</span>, 则<span class="math inline">\(x^n-(-x)^{-n}=\sqrt{5}C\)</span></p>
<p>从而， 对<span class="math inline">\(n\)</span>分奇偶情况讨论， 得到：</p>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(n\)</span>为偶数， 且<span class="math inline">\((x^n)^2-\sqrt{5}C \times (x^n)-1=0\)</span>;</li>
<li><span class="math inline">\(n\)</span>为奇数， 且<span class="math inline">\((x^n)^2-\sqrt{5}C \times (x^n)+1=0\)</span>;</li>
</ol>
<p>利用求根公式+二次剩余+BSGS可以得到最小的<span class="math inline">\(n\)</span> ;</p>
<p>关于二次剩余， 求<span class="math inline">\(x^2=n(\mod p)\)</span> , 先随机找到一个<span class="math inline">\(w=a^2-n\)</span>, 且<span class="math inline">\(w^{(p-1)/2}=-1(\mod p)\)</span>, 那么<span class="math inline">\(x=(a+ \sqrt{w})^{(p+1)/2}\)</span>就是一个合法的<span class="math inline">\(x\)</span>;</p>
<p>因为<span class="math inline">\(x^2 = (a+\sqrt{w})^{p+1}=a^2-w=n\)</span></p>
<h2 id="代码-7">代码</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cmath&gt;</span></span></div><div class="line"> </div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"> </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> LL;</div><div class="line"> </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> Hm = <span class="number">4705219</span>;</div><div class="line"> </div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> seed;</div><div class="line"><span class="keyword">int</span> C,p,w,r2,s5,L,A;</div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Hmap</span> &#123;</span></div><div class="line"> </div><div class="line">	<span class="keyword">int</span> info[Hm][<span class="number">2</span>],nxt[Hm],head[Hm],use[Hm],cnt,tot; </div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= cnt;i ++) head[use[i]] = <span class="number">0</span>;</div><div class="line">		cnt = <span class="number">0</span>, tot = <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line"> </div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> mi,<span class="keyword">int</span> va)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> p = va % Hm;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = head[p];i;i = nxt[i])</div><div class="line">			<span class="keyword">if</span> (info[i][<span class="number">0</span>] == va) <span class="keyword">return</span>;</div><div class="line">		info[++ tot][<span class="number">0</span>] = va,info[tot][<span class="number">1</span>] = mi;</div><div class="line">		<span class="keyword">if</span> (!head[p]) use[++ cnt] = p;</div><div class="line">		nxt[tot] = head[p],head[p] = tot;</div><div class="line">	&#125;</div><div class="line"> </div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> va)</span> </span>&#123;</div><div class="line">		<span class="keyword">int</span> p = va % Hm;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = head[p];i;i = nxt[i])</div><div class="line">			<span class="keyword">if</span> (info[i][<span class="number">0</span>] == va) <span class="keyword">return</span> info[i][<span class="number">1</span>];</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">&#125; hsh[<span class="number">2</span>];</div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Z</span> &#123;</span></div><div class="line">	LL a,b; Z(<span class="keyword">void</span>)&#123;&#125;</div><div class="line">	Z(LL a,LL b) : a(a),b(b)&#123;&#125;</div><div class="line">&#125;;</div><div class="line"> </div><div class="line">Z <span class="keyword">operator</span> *(<span class="keyword">const</span> Z &amp;a,<span class="keyword">const</span> Z &amp;b) &#123;</div><div class="line">	<span class="keyword">return</span> Z((a.a * b.a % p + a.b * b.b % p * w % p) % p,(a.a * b.b % p + a.b * b.a % p) % p);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">updt</span><span class="params">(<span class="keyword">int</span> &amp;a,<span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (b == <span class="number">-1</span>) <span class="keyword">return</span>;</div><div class="line">	<span class="keyword">if</span> (a == <span class="number">-1</span>) a = b; <span class="keyword">else</span></div><div class="line">		a = min(a,b);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="title">RAND</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">return</span> (seed = (seed * <span class="number">31</span> + <span class="number">998244353</span>));</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">fast</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">	LL as = <span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span>(;b;b &gt;&gt;= <span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (b &amp; <span class="number">1</span>) as = as * a % p;</div><div class="line">		a = a * <span class="number">1l</span>l * a % p;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> as;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function">Z <span class="title">fast</span><span class="params">(Z a,<span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">	Z as = Z(<span class="number">1</span>,<span class="number">0</span>);</div><div class="line">	<span class="keyword">for</span>(;b;b &gt;&gt;= <span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (b &amp; <span class="number">1</span>) as = as * a;</div><div class="line">		a = a * a;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> as;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lerend</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (fast(n,(p - <span class="number">1</span>) / <span class="number">2</span>) == <span class="number">1</span>) <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">int</span> _sqrt(<span class="keyword">int</span> n) &#123;</div><div class="line">	<span class="keyword">if</span> (!n) <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> (lerend(n) == <span class="number">-1</span>) <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	<span class="keyword">int</span> a;</div><div class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</div><div class="line">		a = RAND() % p;</div><div class="line">		w = (a * <span class="number">1l</span>l * a - n + p) % p;</div><div class="line">		<span class="keyword">if</span> (lerend(w) == <span class="number">-1</span>) <span class="keyword">break</span>;</div><div class="line">	&#125;</div><div class="line">	Z cur = Z(a,<span class="number">1</span>);</div><div class="line">	cur = fast(cur,(p + <span class="number">1</span>) / <span class="number">2</span>);</div><div class="line">	<span class="keyword">return</span> cur.a;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">int</span> _solve(<span class="keyword">int</span> sig,<span class="keyword">int</span> tar) &#123;</div><div class="line">	<span class="keyword">int</span> mi = <span class="number">-1</span>,least = fast(fast(A,L),p - <span class="number">2</span>);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>,tmp = tar;i &lt;= p / L;i ++,tmp = <span class="number">1l</span>l * tmp * least % p) &#123;</div><div class="line">		<span class="keyword">int</span> fr = i * L,v = hsh[(sig - (fr &amp; <span class="number">1</span>) + <span class="number">2</span>) % <span class="number">2</span>].find(tmp);</div><div class="line">		<span class="keyword">if</span> (v == <span class="number">-1</span>) <span class="keyword">continue</span>;</div><div class="line">		updt(mi,v + fr);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> mi;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">work</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;C, &amp;p);</div><div class="line">	r2 = fast(<span class="number">2</span>,p - <span class="number">2</span>),s5 = _sqrt(<span class="number">5</span>);</div><div class="line">	L = <span class="built_in">sqrt</span>(p);</div><div class="line">	A = (<span class="number">1</span> + s5) % p * <span class="number">1l</span>l * r2 % p;</div><div class="line">	hsh[<span class="number">0</span>].clear();</div><div class="line">	hsh[<span class="number">1</span>].clear();</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>,tmp = <span class="number">1</span>;i &lt; L;i ++,tmp = tmp * <span class="number">1l</span>l * A % p)</div><div class="line">		hsh[i &amp; <span class="number">1</span>].push(i,tmp);</div><div class="line">	C = C * <span class="number">1l</span>l * s5 % p;</div><div class="line">	<span class="keyword">int</span> Ans = <span class="number">-1</span>;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> od = <span class="number">0</span>,sig = <span class="number">1</span>;od &lt; <span class="number">2</span>;od ++,sig *= <span class="number">-1</span>) &#123;</div><div class="line">		<span class="keyword">int</span> delta = (C * <span class="number">1l</span>l * C % p + <span class="number">4</span> * sig % p + p) % p;</div><div class="line">		delta = _sqrt(delta);</div><div class="line">		<span class="keyword">if</span> (delta == <span class="number">-1</span>) <span class="keyword">continue</span>;</div><div class="line">		updt(Ans,_solve(od,(C + delta) % p * <span class="number">1l</span>l * r2 % p));</div><div class="line">		updt(Ans,_solve(od,(C - delta + p) % p * <span class="number">1l</span>l * r2 % p));</div><div class="line">	&#125;</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, Ans);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">	seed = <span class="number">17</span>;</div><div class="line">	<span class="keyword">int</span> T;</div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;T);</div><div class="line">	<span class="keyword">for</span>(;T;T --) work();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125; </div><div class="line">```	</div><div class="line"></div><div class="line"># 【CC SEALCM】Sereja <span class="keyword">and</span> LCM</div><div class="line">## 题目大意</div><div class="line"></div><div class="line">对于$k \in [l,r]$, 其中满足$k|LCM(a_1,a_2...a_n)$且$max(a_i)&lt;=m$的数列个数。 </div><div class="line"></div><div class="line">## 解题报告</div><div class="line"></div><div class="line">这是一个千载难逢的水题呀！</div><div class="line"></div><div class="line">因为$m$和$k$的范围都很小， 所以质因子的个数最多只有$<span class="number">5</span>$个； </div><div class="line"></div><div class="line">用一个$<span class="number">2</span>^<span class="number">5</span>$表示$k$的每个质因子是否满足的状态， 然后压到矩阵里， 大力转移就可以了。</div><div class="line"></div><div class="line">## 代码</div><div class="line"></div><div class="line">```c++</div><div class="line">#include &lt;bits/stdc++.h&gt; </div><div class="line"> </div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>; </div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REP(i,a,b) for(int i=int(a),nn=int(b);i&lt;=nn;++i)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VEP(i,a,b) for(int i=int(a),nn=int(b);i&gt;=nn;--i)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> rep(i,b) for(int i=0,nn=int(b);i&lt;nn;++i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> B(x) (1&lt;&lt;(x))</span></div><div class="line"> </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll; </div><div class="line"> </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> p = <span class="number">1000000007</span>;</div><div class="line"> </div><div class="line"><span class="keyword">int</span> n, test, m, l, r, t, a[<span class="number">5</span>]; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">divide</span><span class="params">(<span class="keyword">int</span> d)</span> </span>&#123;</div><div class="line"> 	t = <span class="number">0</span>; <span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a)); </div><div class="line"> 	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">2</span>; i*i&lt;=d; ++i) </div><div class="line"> 		<span class="keyword">if</span> (d % i==<span class="number">0</span>) &#123; </div><div class="line"> 			a[t++]=<span class="number">1</span>; <span class="keyword">while</span>(d%i==<span class="number">0</span>)a[t<span class="number">-1</span>]*=i,d/=i;  </div><div class="line"> 		&#125; </div><div class="line">  	<span class="keyword">if</span> (d &gt; <span class="number">1</span>) a[t++]=d, d=<span class="number">1</span>; </div><div class="line">&#125; </div><div class="line">  </div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">matrix</span> &#123;</span> </div><div class="line">	<span class="keyword">int</span> x, y; ll a[<span class="number">20</span>][<span class="number">20</span>]; </div><div class="line">	matrix()&#123;x=y=<span class="number">0</span>; <span class="built_in">memset</span>(a,<span class="number">0</span>,<span class="keyword">sizeof</span>(a));&#125;</div><div class="line">	matrix(<span class="keyword">int</span> x,<span class="keyword">int</span> y,<span class="keyword">int</span> t=<span class="number">0</span>):x(x),y(y) &#123;</div><div class="line">		<span class="built_in">memset</span>(a, <span class="number">0</span>, <span class="keyword">sizeof</span>(a)); </div><div class="line">		<span class="keyword">if</span>(t) rep(i, x) a[i][i]=<span class="number">1</span>; </div><div class="line">	&#125; </div><div class="line">	matrix <span class="keyword">operator</span> * (<span class="keyword">const</span> matrix b) <span class="keyword">const</span> &#123; </div><div class="line">		<span class="function">matrix <span class="title">c</span><span class="params">(x, b.y)</span> </span>;</div><div class="line">		rep(i, c.x) rep(j, c.y) rep(k, y)</div><div class="line">			c.a[i][j]=(c.a[i][j]+a[i][k]*b.a[k][j]%p)%p; </div><div class="line">		<span class="keyword">return</span> c; </div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span> </span>&#123; </div><div class="line">		<span class="built_in">cout</span> &lt;&lt; x &lt;&lt; <span class="string">", "</span> &lt;&lt; y &lt;&lt; <span class="built_in">endl</span>; </div><div class="line">		rep(i, x) rep(j, y) <span class="built_in">cout</span>&lt;&lt;a[i][j]&lt;&lt;((j+<span class="number">1</span>==y)?<span class="string">'\n'</span>:<span class="string">' '</span>); </div><div class="line">	&#125; </div><div class="line">	</div><div class="line">&#125; ;</div><div class="line"> </div><div class="line">matrix _fast(matrix x, <span class="keyword">int</span> k) &#123;</div><div class="line">	<span class="function">matrix <span class="title">as</span><span class="params">(x.x, x.y, <span class="number">1</span>)</span></span>; </div><div class="line">	<span class="keyword">for</span> (;k; k&gt;&gt;=<span class="number">1</span>, x=x*x)<span class="keyword">if</span>(k&amp;<span class="number">1</span>)as=as*x;</div><div class="line">	<span class="keyword">return</span> as; </div><div class="line">&#125; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; </div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;test); </div><div class="line">	<span class="keyword">while</span> (test --) &#123; </div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d%d%d"</span>, &amp;n, &amp;m, &amp;l, &amp;r); </div><div class="line">		<span class="keyword">int</span> as = <span class="number">0</span>; </div><div class="line">		REP(d, l, r) &#123; </div><div class="line">			divide(d); <span class="keyword">int</span> w=B(t); <span class="function">matrix <span class="title">trs</span><span class="params">(w, w)</span></span>;  </div><div class="line">			rep(i, w) REP(x,<span class="number">1</span>,m) &#123; <span class="keyword">int</span> S=i; </div><div class="line">				rep(j, t) <span class="keyword">if</span> (x%a[j]==<span class="number">0</span>) S|=B(j); </div><div class="line">				trs.a[S][i]++;</div><div class="line">			&#125;</div><div class="line"><span class="comment">//			trs.print(); </span></div><div class="line">			trs=_fast(trs, n); </div><div class="line">			<span class="function">matrix <span class="title">ini</span><span class="params">(w, <span class="number">1</span>)</span></span>; ini.a[<span class="number">0</span>][<span class="number">0</span>]=<span class="number">1</span>; </div><div class="line">			ini = trs*ini; </div><div class="line">			as += ini.a[w<span class="number">-1</span>][<span class="number">0</span>]; <span class="keyword">if</span>(as&gt;=p)as-=p; </div><div class="line">		&#125; </div><div class="line">		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, as); </div><div class="line">	&#125; </div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="cc-qtreequeries-on-tree-again">【CC QTREE】Queries on tree again!</h1>
<h2 id="题目大意-8">题目大意</h2>
<p>环套树上两点的最短路径的最大连续字段和；</p>
<h2 id="解题报告-8">解题报告</h2>
<p>强行树-&gt;环套树 。。。</p>
<p>首先把环拆开， 变成一棵树+一条边， 对于每个操作<span class="math inline">\(x,y\)</span>进行特判， 判断是否走零散的那一条边。</p>
<p>然后用线段树，树链剖分后，对于每一个区间维护最大连续子段和，最小连续子段和，前缀最大子段和， 后缀最大子段和，前缀最小子段和， 后缀最小子段和， 区间变号标记。</p>
<p>修改的话非常的normal，就是直接树链剖分+线段树区间修改，查询的话比较麻烦， 因为需要完成从深到浅+由浅入深两个过程， 对应线段树的两种区间查询， 写的时候就比较冗长。</p>
<h2 id="代码-8">代码</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt; </span></span></div><div class="line"> </div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>; </div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REP(i,a,b) for(int i=int(a),nn=int(b);i&lt;=nn;++i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VEP(i,a,b) for(int i=int(a),nn=int(b);i&gt;=nn;--i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> rep(i,b) for (int i=0,nn=int(b);i&lt;nn;++i) </span></div><div class="line"> </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll; </div><div class="line"> </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N=<span class="number">100001</span>; </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> S=<span class="number">400001</span>;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">edge</span> &#123;</span> <span class="keyword">int</span> nxt,to,c; </div><div class="line">	edge(<span class="keyword">int</span> nxt=<span class="number">0</span>,<span class="keyword">int</span> to=<span class="number">0</span>,<span class="keyword">int</span> c=<span class="number">0</span>):nxt(nxt),to(to),c(c)&#123;&#125;</div><div class="line">&#125; e[N&lt;&lt;<span class="number">1</span>]; </div><div class="line"><span class="keyword">int</span> n,hed[N],tot,va[N],sn[N],sz[N],de[N],tp[N],f[N],dn[N],bd[N],cnt,u,v,w; </div><div class="line"><span class="keyword">int</span> mnl[S],mnr[S],mn[S],mxl[S],mxr[S],mx[S],sm[S],rv[S],as,asr,m; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y,<span class="keyword">int</span> c)</span> </span>&#123;e[++tot]=edge(hed[x],y,c),hed[x]=tot;&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">in</span><span class="params">(<span class="keyword">int</span> &amp;x)</span> </span>&#123; <span class="keyword">char</span> ch=getchar(); <span class="keyword">int</span> f=<span class="number">1</span>; </div><div class="line">	<span class="keyword">for</span> (;ch&lt;<span class="string">'0'</span>||ch&gt;<span class="string">'9'</span>;ch=getchar()) <span class="keyword">if</span>(ch==<span class="string">'-'</span>)f=<span class="number">-1</span>; </div><div class="line">	<span class="keyword">for</span> (x=<span class="number">0</span>;ch&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>;ch=getchar())x=x*<span class="number">10</span>+ch<span class="number">-48</span>; x*=f; </div><div class="line">&#125; </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; </div><div class="line">	de[x]=de[f[x]]+<span class="number">1</span>,sz[x]=<span class="number">1</span>,sn[x]=<span class="number">0</span>; <span class="keyword">int</span> y;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=hed[x];i;i=e[i].nxt) <span class="keyword">if</span>(y=e[i].to,!sz[y]) </div><div class="line">		va[y]=e[i].c,f[y]=x,dfs(y),sz[x]+=sz[y],sn[x]=((sz[y]&gt;sz[sn[x]])?y:sn[x]); </div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">odr</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> top)</span> </span>&#123;</div><div class="line">	tp[x]=top,dn[x]=++cnt,bd[cnt]=x; </div><div class="line">	<span class="keyword">if</span> (sn[x]) &#123; odr(sn[x],top); <span class="keyword">int</span> y;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i=hed[x];i;i=e[i].nxt) </div><div class="line">			<span class="keyword">if</span>(y=e[i].to,de[y]==de[x]+<span class="number">1</span>&amp;&amp;y!=sn[x]) odr(y,y); </div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">inline</span> <span class="keyword">int</span> _lca(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123; </div><div class="line">	<span class="keyword">int</span> fx=tp[x], fy=tp[y]; </div><div class="line">	<span class="keyword">while</span> (fx!=fy) &#123; <span class="keyword">if</span> (de[fx]&lt;de[fy]) swap(fx,fy),swap(x,y); </div><div class="line">		x=f[fx], fx=tp[x];</div><div class="line">	&#125;  <span class="keyword">if</span> (de[x]&gt;de[y]) swap(x,y); <span class="keyword">return</span> x; </div><div class="line">&#125; </div><div class="line"><span class="keyword">inline</span> <span class="keyword">int</span> _dis(<span class="keyword">int</span> x, <span class="keyword">int</span> y) &#123; <span class="keyword">return</span> de[x]+de[y]-de[_lca(x,y)]*<span class="number">2</span>;&#125;</div><div class="line"> </div><div class="line"><span class="keyword">inline</span> <span class="keyword">void</span> _rev(<span class="keyword">int</span> x) &#123; </div><div class="line">	sm[x]=-sm[x],rv[x]^=<span class="number">1</span>,swap(mn[x],mx[x]),swap(mnl[x],mxl[x]),swap(mnr[x],mxr[x]); </div><div class="line">	mn[x]=-mn[x],mx[x]=-mx[x],mnl[x]=-mnl[x],mnr[x]=-mnr[x],mxl[x]=-mxl[x],mxr[x]=-mxr[x]; </div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">up</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; </div><div class="line">	sm[x]=sm[x&lt;&lt;<span class="number">1</span>]+sm[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>], mx[x]=max(mxr[x&lt;&lt;<span class="number">1</span>]+mxl[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>],max(mx[x&lt;&lt;<span class="number">1</span>],mx[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>])); </div><div class="line">	mxl[x]=max(mxl[x&lt;&lt;<span class="number">1</span>],sm[x&lt;&lt;<span class="number">1</span>]+mxl[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]); </div><div class="line">	mxr[x]=max(mxr[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>],sm[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]+mxr[x&lt;&lt;<span class="number">1</span>]); </div><div class="line">	mn[x]=min(mnr[x&lt;&lt;<span class="number">1</span>]+mnl[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>],min(mn[x&lt;&lt;<span class="number">1</span>],mn[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>])); </div><div class="line">	mnl[x]=min(mnl[x&lt;&lt;<span class="number">1</span>],sm[x&lt;&lt;<span class="number">1</span>]+mnl[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]); </div><div class="line">	mnr[x]=min(mnr[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>],sm[x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>]+mnr[x&lt;&lt;<span class="number">1</span>]); </div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">down</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123; <span class="keyword">if</span> (rv[x]) _rev(x&lt;&lt;<span class="number">1</span>),_rev(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>),rv[x]=<span class="number">0</span>;&#125; </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (l==r) &#123;  mn[x]=mnl[x]=mnr[x]=mx[x]=mxl[x]=mxr[x]=sm[x]=va[bd[l]];&#125; </div><div class="line">	<span class="keyword">else</span> &#123; <span class="keyword">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>; build(x&lt;&lt;<span class="number">1</span>,l,mid),build(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r); up(x);&#125; </div><div class="line">&#125; </div><div class="line"><span class="keyword">void</span> _rivers(<span class="keyword">int</span> x,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> _l,<span class="keyword">int</span> _r) &#123; </div><div class="line">	<span class="keyword">if</span> (_l&lt;=l&amp;&amp;r&lt;=_r) _rev(x);</div><div class="line">	<span class="keyword">else</span> &#123; <span class="keyword">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>;  down(x); </div><div class="line">		<span class="keyword">if</span> (_l&lt;=mid)_rivers(x&lt;&lt;<span class="number">1</span>,l,mid,_l,_r); </div><div class="line">		<span class="keyword">if</span> (_r&gt;mid)_rivers(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,_l,_r); up(x); </div><div class="line">	&#125; </div><div class="line">&#125;</div><div class="line"><span class="keyword">void</span> _qry_r(<span class="keyword">int</span> x,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> _l,<span class="keyword">int</span> _r) &#123; </div><div class="line">	<span class="keyword">if</span> (_l&lt;=l&amp;&amp;r&lt;=_r) &#123; <span class="keyword">if</span>(mx[x]&gt;as)as=mx[x]; <span class="keyword">if</span>(asr+mxr[x]&gt;as)as=asr+mxr[x];</div><div class="line">		asr+=sm[x]; <span class="keyword">if</span> (mxl[x]&gt;asr) asr=mxl[x]; </div><div class="line">	&#125; <span class="keyword">else</span> &#123; <span class="keyword">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>; down(x); </div><div class="line">		<span class="keyword">if</span> (_r&gt;mid) _qry_r(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,_l,_r); </div><div class="line">		<span class="keyword">if</span> (_l&lt;=mid) _qry_r(x&lt;&lt;<span class="number">1</span>,l,mid,_l,_r); </div><div class="line">	&#125; </div><div class="line">&#125; </div><div class="line"><span class="keyword">void</span> _qry_l(<span class="keyword">int</span> x,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> _l,<span class="keyword">int</span> _r) &#123; </div><div class="line">	<span class="keyword">if</span> (_l&lt;=l&amp;&amp;r&lt;=_r) &#123; <span class="keyword">if</span>(mx[x]&gt;as)as=mx[x]; <span class="keyword">if</span>(asr+mxl[x]&gt;as)as=asr+mxl[x]; </div><div class="line">		asr+=sm[x]; <span class="keyword">if</span> (mxr[x]&gt;asr) asr=mxr[x]; </div><div class="line">	&#125; <span class="keyword">else</span> &#123; <span class="keyword">int</span> mid=(l+r)&gt;&gt;<span class="number">1</span>; down(x); </div><div class="line">		<span class="keyword">if</span> (_l&lt;=mid) _qry_l(x&lt;&lt;<span class="number">1</span>,l,mid,_l,_r); </div><div class="line">		<span class="keyword">if</span> (_r&gt;mid) _qry_l(x&lt;&lt;<span class="number">1</span>|<span class="number">1</span>,mid+<span class="number">1</span>,r,_l,_r); </div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span> </span>&#123; </div><div class="line">	<span class="keyword">int</span> fx=tp[x], fy=tp[y]; <span class="keyword">while</span> (fx!=fy) &#123; </div><div class="line">		<span class="keyword">if</span> (de[fx]&lt;de[fy]) swap(fx,fy),swap(x,y); </div><div class="line">		_rivers(<span class="number">1</span>,<span class="number">1</span>,n,dn[fx],dn[x]),x=f[fx],fx=tp[x]; </div><div class="line">	&#125; </div><div class="line">	<span class="keyword">if</span> (de[x]&gt;de[y]) swap(x,y); </div><div class="line">	<span class="keyword">if</span> (x!=y) _rivers(<span class="number">1</span>,<span class="number">1</span>,n,dn[x]+<span class="number">1</span>,dn[y]); </div><div class="line">&#125; </div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123; <span class="keyword">int</span> lca=_lca(x,y); </div><div class="line">	<span class="keyword">while</span> (tp[x]!=tp[lca]) _qry_r(<span class="number">1</span>,<span class="number">1</span>,n,dn[tp[x]],dn[x]),x=f[tp[x]]; </div><div class="line">	<span class="keyword">if</span> (x!=lca) _qry_r(<span class="number">1</span>,<span class="number">1</span>,n,dn[lca]+<span class="number">1</span>,dn[x]); </div><div class="line">	<span class="keyword">static</span> <span class="keyword">int</span> _l[N],_r[N],top; top=<span class="number">0</span>; </div><div class="line">	<span class="keyword">while</span> (tp[y]!=tp[lca]) _l[++top]=dn[tp[y]],_r[top]=dn[y],y=f[tp[y]]; </div><div class="line">	<span class="keyword">if</span> (y!=lca) _l[++top]=dn[lca]+<span class="number">1</span>,_r[top]=dn[y]; </div><div class="line">	<span class="keyword">while</span> (top) _qry_l(<span class="number">1</span>,<span class="number">1</span>,n,_l[top],_r[top]),--top;</div><div class="line">&#125; 	</div><div class="line">	</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; </div><div class="line">	in(n); <span class="keyword">int</span> x,y,c;<span class="keyword">char</span> type; rep(i,n) in(x),in(y),in(c),add(x,y,c),add(y,x,c); </div><div class="line">	dfs(<span class="number">1</span>), odr(<span class="number">1</span>,<span class="number">1</span>); REP(x,<span class="number">1</span>,n) <span class="keyword">for</span>(<span class="keyword">int</span> i=hed[x];i;i=e[i].nxt)</div><div class="line">		<span class="keyword">if</span> (y=e[i].to, f[x]!=y&amp;&amp;f[y]!=x) u=x,v=y,w=e[i].c; </div><div class="line"><span class="comment">//	cout &lt;&lt; u&lt;&lt;"-&gt;"&lt;&lt;v&lt;&lt;": "&lt;&lt;w&lt;&lt;endl; </span></div><div class="line"><span class="comment">//	REP(i,1,n) cout &lt;&lt; f[i] &lt;&lt;"-&gt;" &lt;&lt;i&lt;&lt;": "&lt;&lt;tp[i]&lt;&lt;", "&lt;&lt;va[i]&lt;&lt;endl;</span></div><div class="line">	<span class="keyword">for</span>(build(<span class="number">1</span>,<span class="number">1</span>,n),in(m); m; --m) &#123; </div><div class="line">		type=getchar(); <span class="keyword">while</span>(type!=<span class="string">'?'</span>&amp;&amp;type!=<span class="string">'f'</span>)type=getchar(); </div><div class="line">		in(x),in(y);  <span class="keyword">if</span> (type==<span class="string">'f'</span>) &#123; </div><div class="line">			<span class="keyword">if</span> (_dis(x,u)+_dis(y,v)&gt;_dis(x,v)+_dis(y,u))swap(x,y); </div><div class="line">			<span class="keyword">if</span> (_dis(x,y)&lt;_dis(x,u)+_dis(y,v)+<span class="number">1</span>) reverse(x,y); </div><div class="line">			<span class="keyword">else</span> reverse(x,u), w=-w, reverse(v,y); </div><div class="line">		&#125; <span class="keyword">else</span> &#123; </div><div class="line">			as=<span class="number">0</span>, asr=<span class="number">0</span>; <span class="keyword">if</span> (_dis(x,u)+_dis(y,v)&gt;_dis(x,v)+_dis(y,u)) swap(x,y); </div><div class="line">			<span class="keyword">if</span> (_dis(x,y)&lt;_dis(x,u)+_dis(y,v)+<span class="number">1</span>) query(x,y); </div><div class="line">			<span class="keyword">else</span> &#123; query(x,u);<span class="keyword">if</span>(w&gt;as)as=w;<span class="keyword">if</span>(asr+w&gt;as)as=asr+w; </div><div class="line">				asr+=w; <span class="keyword">if</span>(w&gt;asr) asr=w; query(v,y);</div><div class="line">			&#125; </div><div class="line">			<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, as); </div><div class="line">		&#125; </div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="cc-permutejust-some-permutations-3">【CC PERMUTE】Just Some Permutations 3</h1>
<h2 id="题目大意-9">题目大意</h2>
<p>长度为<span class="math inline">\(n\)</span>的，相邻两个数的和不超过的<span class="math inline">\(m\)</span>的合法排列个数。</p>
<h2 id="解题报告-9">解题报告</h2>
<p>考虑从大到小插入<span class="math inline">\(n\)</span>个数， 每次插入一个数<span class="math inline">\(n\)</span>， 需要用<span class="math inline">\(\leqslant m-n\)</span>的数将他包裹起来， 也就是形如<span class="math inline">\(XnY\)</span>, 或者<span class="math inline">\(|nX\)</span>,或者<span class="math inline">\(Xn|\)</span>的形式。</p>
<p>现在考虑有几个可以选择来包裹<span class="math inline">\(n\)</span>的数，开始显然是<span class="math inline">\(m-n\)</span>个， 如果使用形如<span class="math inline">\(|nX\)</span>、<span class="math inline">\(Xn|\)</span>的形式进行包裹， 那么<span class="math inline">\(X\)</span>将不能再被使用， 成为左右边界<span class="math inline">\(|\)</span>的一部分，如果使用形如<span class="math inline">\(XnY\)</span>的形式包裹， 那么<span class="math inline">\(XnY\)</span>可以看成<span class="math inline">\(X&#39;\)</span>, 一个新的用来包裹的“数”；</p>
<p>可以发现， 随着插入<span class="math inline">\(n\)</span>,<span class="math inline">\(n-1\)</span>…<span class="math inline">\(\frac{m+1}{2}+1\)</span> , 用来包裹的数的个数是不变的。</p>
<ol style="list-style-type: decimal">
<li>如果<span class="math inline">\(m\)</span>为奇数， 那么<span class="math inline">\((m+1)/2\)</span>插入时， 剩余的数的个数是<span class="math inline">\(m-n+1\)</span>， 方案数是<span class="math inline">\((m-n+1)!\)</span>,总的方案数是<span class="math inline">\((2k+k(k-1))^{n-\frac{m+1}{2}}*(m-n+1)!\)</span></li>
<li>如果<span class="math inline">\(m\)</span>为偶数， 那么<span class="math inline">\((m+1)/2\)</span>插入时， 剩余的数的个数是<span class="math inline">\(m-n\)</span>, 方案数是<span class="math inline">\((2k+k(k-1))^{n-\frac{m+1}{2}}*(m-n)!\)</span></li>
</ol>
<p>其中<span class="math inline">\(k=m-n\)</span>, 表示可以用来包裹的数的个数。</p>
<h2 id="代码-9">代码</h2>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"> </div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>; </div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REP(i,a,b) for(int i=int(a),nn=int(b);i&lt;=nn;++i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> VEP(i,a,b) for(int i=int(a),nn=int(b);i&gt;=nn;--i) </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> rep(i,b) for(int i=0,nn=int(b);i&lt;nn;++i) </span></div><div class="line"> </div><div class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll; </div><div class="line"> </div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> p =<span class="number">1000000007</span>;</div><div class="line"> </div><div class="line"><span class="keyword">int</span> n,m,T,k,fac[<span class="number">1000001</span>]; </div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">inline</span> ll <span class="title">fast</span><span class="params">(ll x,<span class="keyword">int</span> k)</span> </span>&#123;ll as=<span class="number">1</span>;<span class="keyword">for</span>(;k;k&gt;&gt;=<span class="number">1</span>,x=x*x%p)<span class="keyword">if</span>(k&amp;<span class="number">1</span>)as=as*x%p;<span class="keyword">return</span> as;&#125;</div><div class="line"> </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; </div><div class="line">	<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;T); </div><div class="line">	fac[<span class="number">0</span>]=<span class="number">1</span>; REP(i,<span class="number">1</span>,<span class="number">1000000</span>)fac[i]=<span class="number">1l</span>l*fac[i<span class="number">-1</span>]*i%p;</div><div class="line">	<span class="keyword">while</span> (T--) &#123; </div><div class="line">		<span class="built_in">scanf</span>(<span class="string">"%d%d"</span>, &amp;n, &amp;m); k=m-n; </div><div class="line">		<span class="keyword">if</span> (m &amp; <span class="number">1</span>) <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, fast(<span class="number">1l</span>l*k*(k+<span class="number">1</span>)%p,n-(m+<span class="number">1</span>)/<span class="number">2</span>)*fac[k+<span class="number">1</span>]%p); </div><div class="line">		<span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, fast(<span class="number">1l</span>l*k*(k+<span class="number">1</span>)%p,n-m/<span class="number">2</span>)*fac[k]%p); </div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/cc1/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/cc3/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>

    <!-- share -->
    
        

        
<!-- JiaThis Button BEGIN -->
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?type=left&amp;move=0&amp;btn=l2.gif&amp;uid=2131170" charset="utf-8"></script>
<!-- JiaThis Button END -->



    
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">留言</h2>

  
	<div id="uyan_frame"></div>
  
</section>

	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2017-03-14 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/题目集锦/">题目集锦<span>5</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/线段树/">线段树<span>10</span></a></li> <li><a href="/tags/倍增/">倍增<span>8</span></a></li> <li><a href="/tags/树链剖分/">树链剖分<span>7</span></a></li> <li><a href="/tags/组合数学/">组合数学<span>2</span></a></li> <li><a href="/tags/DP/">DP<span>6</span></a></li> <li><a href="/tags/数论/">数论<span>5</span></a></li> <li><a href="/tags/分块/">分块<span>3</span></a></li> <li><a href="/tags/矩阵乘法/">矩阵乘法<span>1</span></a></li> <li><a href="/tags/匹配/">匹配<span>1</span></a></li> <li><a href="/tags/BSGS/">BSGS<span>1</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#cc-tripschildren-trips"><span class="toc-article-text">【CC TRIPS】Children Trips</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#题目大意"><span class="toc-article-text">题目大意</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#解题报告"><span class="toc-article-text">解题报告</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#代码"><span class="toc-article-text">代码</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#cc-seaeqsereja-and-equality"><span class="toc-article-text">【CC SEAEQ】Sereja and Equality</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#题目大意-1"><span class="toc-article-text">题目大意</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#解题报告-1"><span class="toc-article-text">解题报告</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#代码-1"><span class="toc-article-text">代码</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#cc-parsinsine-partition-function"><span class="toc-article-text">【CC PARSIN】Sine Partition Function</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#题目大意-2"><span class="toc-article-text">题目大意</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#解题报告-2"><span class="toc-article-text">解题报告</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#代码-2"><span class="toc-article-text">代码</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#cc-lecoinslittle-elephant-and-colored-coins"><span class="toc-article-text">【CC LECOINS】Little Elephant and Colored Coins</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#题目大意-3"><span class="toc-article-text">题目大意</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#解题报告-3"><span class="toc-article-text">解题报告</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#代码-3"><span class="toc-article-text">代码</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#cc-anudtq-dynamic-trees-and-queries"><span class="toc-article-text">【CC ANUDTQ】 Dynamic Trees and Queries</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#题目大意-4"><span class="toc-article-text">题目大意</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#解题报告-4"><span class="toc-article-text">解题报告</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#代码-4"><span class="toc-article-text">代码</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#cc-matchexpected-maximum-matching"><span class="toc-article-text">【CC MATCH】Expected Maximum Matching</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#题目大意-5"><span class="toc-article-text">题目大意</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#解题报告-5"><span class="toc-article-text">解题报告</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#代码-5"><span class="toc-article-text">代码</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#cc-cot5count-on-a-treap"><span class="toc-article-text">【CC COT5】Count on a Treap</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#题目大意-6"><span class="toc-article-text">题目大意</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#解题报告-6"><span class="toc-article-text">解题报告</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#代码-6"><span class="toc-article-text">代码</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#cc-fnfibonacci-number"><span class="toc-article-text">【CC FN】Fibonacci Number</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#题目大意-7"><span class="toc-article-text">题目大意</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#解题报告-7"><span class="toc-article-text">解题报告</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#代码-7"><span class="toc-article-text">代码</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#cc-qtreequeries-on-tree-again"><span class="toc-article-text">【CC QTREE】Queries on tree again!</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#题目大意-8"><span class="toc-article-text">题目大意</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#解题报告-8"><span class="toc-article-text">解题报告</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#代码-8"><span class="toc-article-text">代码</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#cc-permutejust-some-permutations-3"><span class="toc-article-text">【CC PERMUTE】Just Some Permutations 3</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#题目大意-9"><span class="toc-article-text">题目大意</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#解题报告-9"><span class="toc-article-text">解题报告</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#代码-9"><span class="toc-article-text">代码</span></a></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->
 
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2131170"></script>



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2017 shallwe
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script type="text/javascript" color="0,0,0" opacity='1.0' zIndex="-2" count="200" src="/js/src/particle.js"></script>  
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
